<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0a1120" />
  <meta name="theme-color" content="#0a1120" media="(prefers-color-scheme: dark)" />
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Mobile RTA (FFT/Oct/Heatmap + dB-A)</title>

  <style>
    :root{
      --bg1:#0b1220; --bg2:#0a1120; --card:#111827; --text:#e5e7eb; --muted:#9ca3af;
      --gridH:rgba(255,255,255,.06); --gridV:rgba(255,255,255,.035);
      --frame:rgba(255,255,255,.08); --label:rgba(255,255,255,.55);
      --fft:#34d399; --peak:#a78bfa; --hold:#facc15; --bar:#34d399;
      --heatmap-color-1:#0b1220; --heatmap-color-2:#3b82f6; --heatmap-color-3:#22c55e;
      --heatmap-color-4:#facc15; --heatmap-color-5:#ef4444;
      --dba-meter-bg-0-50:#22c55e; --dba-meter-bg-50-70:#facc15; --dba-meter-bg-70-90:#ef4444; --dba-meter-bg-90-140:#be123c;
      --oct-range-slider-width: 180px;
    }
    :root{ color-scheme:dark }
    html{ background:#0a1120 }
    body{
      margin:0; height:100%;
      background:radial-gradient(1200px 600px at 70% -10%, #0f1730 10%, var(--bg1) 60%, var(--bg2) 100%);
      color:var(--text); font-family:system-ui,-apple-system,Segoe UI,Roboto,"Noto Sans Thai",sans-serif;
      -webkit-touch-callout:none; -webkit-user-select:none; user-select:none; overscroll-behavior:contain;
    }
    body::before,body::after{content:"";position:fixed;left:0;right:0;z-index:9999;background:#0a1120;pointer-events:none}
    body::before{top:0;height:env(safe-area-inset-top)} body::after{bottom:0;height:env(safe-area-inset-bottom)}
    @supports(padding: env(safe-area-inset-left)){
      html::before,html::after{content:"";position:fixed;top:0;bottom:0;background:#0a1120;z-index:9998;pointer-events:none}
      html::before{left:0;width:env(safe-area-inset-left)} html::after{right:0;width:env(safe-area-inset-right)}
    }

    .wrap{display:flex;flex-direction:column;gap:12px;max-width:920px;margin:0 auto;
      padding-left:calc(12px + env(safe-area-inset-left));
      padding-right:calc(12px + env(safe-area-inset-right));
      padding-top:calc(12px + env(safe-area-inset-top));
      padding-bottom:calc(12px + env(safe-area-inset-bottom));
    }
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .card{background:var(--card);border:1px solid #1f2937;border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:12px}
    button,select,input[type=range],input[type=number]{-webkit-tap-highlight-color:transparent}
    button{background:#10b981;border:none;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
    button.secondary{background:#374151} button.ghost{background:#1f2937}
    label{font-size:12px;color:var(--muted)}
    .meters{display:grid;grid-template-columns:1fr;gap:12px}
    canvas{width:100%;height:320px;background:#0b1220;border-radius:12px;touch-action:none}

    #dbMeterContainer{position:relative;background:rgba(255,255,255,.08);border-radius:999px;overflow:hidden}
    #dbMeterCanvas{height:20px;background:transparent;border-radius:999px}
    .dbLabel{position:absolute;font-size:10px;color:var(--muted);bottom:4px}

    .hint{font-size:12px;color:var(--muted)}
    .kv{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:8px}
    .kv div{background:#0e1628;border:1px solid #1f2937;border-radius:12px;padding:8px}
    .kv b{display:block;color:#cbd5e1;font-size:12px;margin-bottom:4px}
    .badges{display:flex;justify-content:flex-end;gap:6px;margin:4px 0 6px 0}
    .badge{padding:4px 8px;border-radius:999px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);font-size:12px;color:#e5e7eb;white-space:nowrap}
    .tip{position:absolute;padding:4px 6px;font-size:12px;color:#e5e7eb;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);border-radius:8px;transform:translate(-50%,-100%);pointer-events:none;white-space:nowrap;z-index:10}
    .plot{position:relative}

    .dba-values-row{display:flex;justify-content:space-between;gap:8px}
    .dba-values-row .kv-item{flex:1;background:#0e1628;border:1px solid #1f2937;border-radius:12px;padding:8px;text-align:center}
    .dba-values-row .kv-item b{display:block;color:#cbd5e1;font-size:12px;margin-bottom:4px}

    /* ===== Inline compact octave range slider ===== */
    .oct-head{display:flex;align-items:center;gap:10px;justify-content:space-between}
    .oct-left{display:flex;align-items:center;gap:10px;min-width:0;flex:1}
    #octRangeSlider{ width:var(--oct-range-slider-width); height:4px; }
    @media (max-width:560px){ #octRangeSlider{ width:140px } }

    /* Heatmap controls inline */
    .heat-controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .heat-controls label input[type=number]{width:64px;padding:4px;border-radius:6px;border:1px solid #374151;background:#1f2937;color:white;}
    .heat-controls input[type=range]{width:120px}
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Error banner -->
    <div id="errBox" class="card" style="display:none;border-color:#b91c1c;background:#111317">
      <b style="color:#fecaca">‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î‡πÑ‡∏î‡πâ</b>
      <div id="errMsg" class="hint" style="color:#fca5a5">‚Äî</div>
    </div>

    <div class="card">
      <div class="row" style="justify-content:space-between">
        <div>
          <h2 style="margin:0 0 4px 0">my RTAs</h2>
          <div class="hint">‡πÅ‡∏Å‡∏ô X = Log (20 Hz ‚Üí 20 kHz) ‚Ä¢ Heatmap ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÉ‡∏ô‡∏≠‡∏î‡∏µ‡∏ï</div>
        </div>
        <div class="row">
          <button id="btnStart">‚ñ∂Ô∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏±‡∏î</button>
          <button id="btnStop" class="secondary" disabled>‚è∏Ô∏è ‡∏´‡∏¢‡∏∏‡∏î</button>
          <button id="btnHold" class="ghost" aria-pressed="false">üìå Hold Peak: OFF</button>
          <button id="btnClear" class="secondary">‚ôªÔ∏è Clear Peak</button>
        </div>
      </div>

      <div class="row" style="margin-top:8px">
        <label>FFT Size
          <select id="fft">
            <option value="2048">2048</option>
            <option value="4096" selected>4096</option>
            <option value="8192">8192</option>
            <option value="16384">16384</option>
          </select>
        </label>
        <label> Smoothing <input id="smoothing" type="range" min="0" max="0.95" step="0.01" value="0.75"></label>
        <label> Averaging <input id="avg" type="checkbox" checked></label>
        <label> A-weighting (‡πÄ‡∏î‡πÇ‡∏°‡πà) <input id="aWeight" type="checkbox"></label>
      </div>

      <div class="row">
        <label>‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏õ‡∏¥‡∏î DSP ‡∏Ç‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏ö (‡∏ö‡∏≤‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏≠‡∏≤‡∏à‡πÑ‡∏°‡πà‡∏¢‡∏≠‡∏°‡∏õ‡∏¥‡∏î):</label>
        <div class="row">
          <label>echoCancellation <input id="ec" type="checkbox" checked></label>
          <label>noiseSuppression <input id="ns" type="checkbox" checked></label>
          <label>autoGainControl <input id="agc" type="checkbox" checked></label>
        </div>
      </div>
    </div>

    <div class="meters">
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
          <b>RTA ‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î (FFT, Log Frequency)</b>
          <span class="hint" id="labelRate">‚Äî</span>
        </div>
        <div class="badges">
          <span class="badge" id="fftPeakText">Peak: ‚Äî</span>
          <span class="badge" id="fftHoldText" style="display:none;">Hold: ‚Äî</span>
        </div>
        <div class="plot">
          <canvas id="fftCanvas" width="1200" height="320"></canvas>
          <div id="fftTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <!-- Header row: Title | [slider] | [22 Hz ‚Äì ‚Ä¶ + dropdowns] -->
        <div class="oct-head" style="margin-bottom:2px">
          <div class="oct-left">
            <b id="octTitle">RTA ‡πÅ‡∏ö‡∏ö 1/6 Octave (Linear Axis)</b>
            <input id="octRangeSlider" type="range" min="64" max="1023" step="1" value="255" aria-label="Octave bar range">
          </div>
          <span class="row" style="gap:10px;align-items:center">
            <span class="hint" id="labelOct">20 Hz ‚Äì 20 kHz</span>
            <label>Octave
              <select id="octRes">
                <option value="3">1/3</option>
                <option value="6" selected>1/6</option>
              </select>
            </label>
            <label>Range
              <select id="octRangePreset">
                <option value="127">0‚Äì127</option>
                <option value="255" selected>0‚Äì255</option>
                <option value="511">0‚Äì511</option>
              </select>
            </label>
            <span class="hint" id="octRangeText">0‚Äì255</span>
          </span>
        </div>

        <div class="badges">
          <span class="badge" id="octPeakText">Peak: ‚Äî</span>
          <span class="badge" id="octHoldText" style="display:none;">Hold: ‚Äî</span>
        </div>
        <div class="plot">
          <canvas id="octCanvas" width="1200" height="320"></canvas>
          <div id="octTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>

      <div class="card" id="heatmapCard">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:6px">
          <b>Spectrogram / Heatmap</b>
          <div class="heat-controls">
            <label>Mode
              <select id="heatScaleMode">
                <option value="auto" selected>Auto</option>
                <option value="abs">Absolute</option>
                <option value="rel">Feedback (Relative)</option>
              </select>
            </label>
            <label id="heatAbsMinWrap">Min <input id="heatMin" type="number" step="1" value="-60"></label>
            <label id="heatAbsMaxWrap">Max <input id="heatMax" type="number" step="1" value="-20"></label>
            <label>Contrast <input id="heatGamma" type="range" min="0.6" max="2" step="0.05" value="1.2"></label>
            <button id="btnToggleHeatmap" class="ghost" aria-pressed="true">üî• Heatmap: ON</button>
          </div>
        </div>
        <div class="plot">
          <canvas id="heatmapCanvas" width="1200" height="320"></canvas>
          <div id="heatmapTip" class="tip" style="display:none">‚Äî</div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center;margin-bottom:2px">
          <b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏±‡∏á‡∏£‡∏ß‡∏° dB-A</b>
          <button id="btnResetDba" class="secondary" style="font-size:12px;padding:6px 10px;">‚ôªÔ∏è Reset AVG/MAX</button>
        </div>
        <div id="dbMeterContainer">
          <canvas id="dbMeterCanvas" width="1200" height="20"></canvas>
          <span class="dbLabel" style="left:0%">0</span>
          <span class="dbLabel" style="left:28.57%">40</span>
          <span class="dbLabel" style="left:57.14%">80</span>
          <span class="dbLabel" style="left:85.71%">120</span>
          <span class="dbLabel" style="right:0">140</span>
        </div>
        <div class="dba-values-row" style="margin-top:12px;">
          <div class="kv-item"><b>Realtime (dB-A)</b><span id="dbRealtimeValue">‚Äî</span></div>
          <div class="kv-item"><b>AVG (dB-A)</b><span id="dbAvgValue">‚Äî</span></div>
          <div class="kv-item"><b>MAX (dB-A)</b><span id="dbMaxValue">‚Äî</span></div>
        </div>
      </div>
    </div>

    <div class="card kv">
      <div><b>‡∏£‡∏∞‡∏î‡∏±‡∏ö RMS (‡∏î‡∏¥‡∏ö dBFS)</b><span id="rms">‚Äî</span></div>
      <div><b>‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡∏û‡∏µ‡∏Ñ‡πÇ‡∏î‡∏¢‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì</b><span id="peak">‚Äî</span></div>
    </div>

    <div class="card row" style="justify-content:space-between;align-items:center;margin-top:0">
      <div class="hint">‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏≠‡∏≠‡∏ü‡πÄ‡∏ã‡πá‡∏ï‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á dBFS ‡πÄ‡∏õ‡πá‡∏ô dBA (‡∏à‡∏≤‡∏Å‡πÑ‡∏°‡∏Ñ‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠)</div>
      <label>Calibration Offset (dB) <input id="calibrationOffset" type="number" min="0" step="0.1" value="80" style="width:60px;padding:4px;border-radius:6px;border:1px solid #374151;background:#1f2937;color:white;"></label>
    </div>

    <div class="card hint">‡∏Ç‡πâ‡∏≠‡∏à‡∏≥‡∏Å‡∏±‡∏î: ‡πÑ‡∏°‡∏Ñ‡πå‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠‡∏°‡∏µ DSP/AGC ‡πÅ‡∏•‡∏∞‡∏Å‡∏≤‡∏£‡∏ï‡∏≠‡∏ö‡∏™‡∏ô‡∏≠‡∏á‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà‡πÑ‡∏°‡πà‡πÅ‡∏ü‡∏•‡∏ï ‡πÉ‡∏ä‡πâ‡∏î‡∏π‡πÅ‡∏ô‡∏ß EQ ‡πÑ‡∏î‡πâ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡πÉ‡∏ä‡πà‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏±‡∏î SPL ‡∏°‡∏∑‡∏≠‡∏≠‡∏≤‡∏ä‡∏µ‡∏û</div>
  </div>

  <script>
  (()=>{

    // ===== Const & helpers =====
    const PAD={L:40,R:10,T:10,B:32}, LABEL_Y=10;
    const HEATMAP_UPDATE_MS=33, HEATMAP_FREQ_BINS=300, HM_HISTORY=200;

    const getStyle=(p)=>getComputedStyle(document.documentElement).getPropertyValue(p).trim();
    const GRID_H=getStyle('--gridH'), GRID_V=getStyle('--gridV');
    const FRAME=getStyle('--frame'), LABEL=getStyle('--label');
    const FFT_COLOR=getStyle('--fft'), PEAK_COLOR=getStyle('--peak');
    const HOLD_COLOR=getStyle('--hold'), BAR_COLOR=getStyle('--bar');

    const dbfs=v=>20*Math.log10(v/255+1e-12);
    const clamp01=v=>Math.min(1,Math.max(0,v));
    function aWeighting(f){const f2=f*f;const ra=(12200**2*f2**2)/((f2+20.6**2)*(f2+12200**2)*Math.sqrt((f2+107.7**2)*(f2+737.9**2)));return 20*Math.log10(ra)+2.0;}
    function fmtHz(f){return f>=1000?((f/1000>=10?(f/1000).toFixed(0):(f/1000).toFixed(1))+' kHz'):(Math.round(f)+' Hz');}

    // ===== DOM =====
    const btnStart=document.getElementById('btnStart');
    const btnStop=document.getElementById('btnStop');
    const btnHold=document.getElementById('btnHold');
    const btnClear=document.getElementById('btnClear');
    const btnToggleHeatmap=document.getElementById('btnToggleHeatmap');
    const btnResetDba=document.getElementById('btnResetDba');

    const fftSel=document.getElementById('fft');
    const smoothing=document.getElementById('smoothing');
    const avgChk=document.getElementById('avg');
    const aWeightChk=document.getElementById('aWeight');

    const fftPeakText=document.getElementById('fftPeakText'), fftHoldText=document.getElementById('fftHoldText');
    const octPeakText=document.getElementById('octPeakText'), octHoldText=document.getElementById('octHoldText');

    const fftCanvas=document.getElementById('fftCanvas');
    const octCanvas=document.getElementById('octCanvas');
    const heatmapCanvas=document.getElementById('heatmapCanvas');
    const dbMeterCanvas=document.getElementById('dbMeterCanvas');

    const fftTip=document.getElementById('fftTip'), octTip=document.getElementById('octTip'), heatmapTip=document.getElementById('heatmapTip');

    const dbRealtimeValue=document.getElementById('dbRealtimeValue');
    const dbAvgValue=document.getElementById('dbAvgValue');
    const dbMaxValue=document.getElementById('dbMaxValue');

    const calibrationInput=document.getElementById('calibrationOffset');
    const labelRate=document.getElementById('labelRate');
    const labelOct=document.getElementById('labelOct');
    const octTitle=document.getElementById('octTitle');
    const octResSel=document.getElementById('octRes');

    // Octave: preset + slider + label
    const octRangePreset=document.getElementById('octRangePreset');
    const octRangeSlider=document.getElementById('octRangeSlider');
    const octRangeText=document.getElementById('octRangeText');

    // Heatmap controls
    const heatScaleModeSel=document.getElementById('heatScaleMode');
    const heatMinInp=document.getElementById('heatMin');
    const heatMaxInp=document.getElementById('heatMax');
    const heatGammaInp=document.getElementById('heatGamma');
    const heatAbsMinWrap=document.getElementById('heatAbsMinWrap');
    const heatAbsMaxWrap=document.getElementById('heatAbsMaxWrap');

    const rmsEl=document.getElementById('rms');
    const peakEl=document.getElementById('peak');

    const ctxFFT=fftCanvas.getContext('2d');
    const ctxOct=octCanvas.getContext('2d');
    const ctxHeatmap=heatmapCanvas.getContext('2d');
    const ctxDbMeter=dbMeterCanvas.getContext('2d');

    // ===== State =====
    let audioCtx, analyser, micSrc, rafId;
    let dataArray, freqArray;
    let sampleRate=48000;

    let avgBuffer=null;
    let running=false, holdEnabled=false;

    let peakArray=null;      // FFT hold
    let peakOct=null;        // Octave hold
    let guideFFT=null, guideOCT=null, guideHeatmap=null;

    let octN=6;
    let bands=[];

    // Heatmap state
    let heatmapData=[];
    let heatmapFreqBinMap=null;
    let lastHeatmapUpdate=0;
    let heatmapEnabled=true;

    // Heatmap scaling state
    let heatScaleMode='auto'; // 'auto' | 'abs' | 'rel'
    let heatDbMin=-60, heatDbMax=-20;
    let heatGamma=1.2;

    // Relative (feedback) stats
    let relMean=null, relVar=null;
    const REL_ALPHA=0.1; // running stats speed

    let calibrationOffset=parseFloat(calibrationInput.value);
    let maxDba=-Infinity;
    let dbaValues=[];

    // Dynamic range for octave bars
    let octRangeMax=parseInt(octRangePreset.value,10);

    // ===== Freq helpers =====
    const fmax=()=>Math.min(sampleRate/2,20000);
    const fmin=20;
    function mapLogX(f,w){const fm=fmax();const t=(Math.log10(Math.max(f,fmin))-Math.log10(fmin))/(Math.log10(fm)-Math.log10(fmin));return PAD.L+t*(w-PAD.L-PAD.R);}
    function xToFreq(x,w){const fm=fmax();const plotW=w-PAD.L-PAD.R;const t=clamp01((x-PAD.L)/plotW);const lf=Math.log10(fmin)+t*(Math.log10(fm)-Math.log10(fmin));return Math.pow(10,lf);}
    function mapDbToY(db,h){const norm=clamp01((db+100)/100);const plotH=h-PAD.T-PAD.B;return PAD.T+(1-norm)*plotH;}
    function mapLinearToYOct(v,h){const norm=clamp01(v/Math.max(1,octRangeMax));const plotH=h-PAD.T-PAD.B;return PAD.T+(1-norm)*plotH;}

    // Old discrete mapping kept for other uses (FFT grid preview)
    function mapDbToColor(db){
      if(db<-60)return getStyle('--heatmap-color-1');
      if(db<-40)return getStyle('--heatmap-color-2');
      if(db<-20)return getStyle('--heatmap-color-3');
      if(db<-5)return getStyle('--heatmap-color-4');
      return getStyle('--heatmap-color-5');
    }

    // New normalized color mapping (0..1 -> palette)
    function mapDbToColorNorm(t){
      const stops=[
        getStyle('--heatmap-color-1'),
        getStyle('--heatmap-color-2'),
        getStyle('--heatmap-color-3'),
        getStyle('--heatmap-color-4'),
        getStyle('--heatmap-color-5'),
      ];
      const i=Math.min(3, Math.floor(t*4));
      return stops[i + (t > (i+0.5)/4 ? 1 : 0)];
    }
    const norm01=(v, vmin, vmax, g=1)=>Math.pow(Math.min(1,Math.max(0,(v-vmin)/(vmax-vmin))), g);

    function percentile(arr, p){
      if(!arr.length) return 0;
      const k = Math.max(0, Math.min(arr.length-1, Math.floor((p/100)*arr.length)));
      const a = [...arr].sort((x,y)=>x-y);
      return a[k];
    }

    function updateRunningStats(i, val){
      if(relMean[i]===undefined){relMean[i]=val; relVar[i]=0; return;}
      const m = relMean[i] + REL_ALPHA*(val - relMean[i]);
      const v = (1-REL_ALPHA)*(relVar[i] + REL_ALPHA*(val - relMean[i])*(val - m));
      relMean[i]=m; relVar[i]=v;
    }
    function zScore(i, val){
      const sd = Math.sqrt(Math.max(1e-6, relVar[i]));
      return (val - relMean[i]) / (sd || 1e-3);
    }

    function genBands(n){
      const r=Math.pow(2,1/n), fm=fmax();
      const kmin=Math.ceil(Math.log(fmin/1000)/Math.log(r));
      const kmax=Math.floor(Math.log(fm/1000)/Math.log(r));
      const edgeHalf=Math.pow(2,1/(2*n));
      const arr=[];
      for(let k=kmin;k<=kmax;k++){
        const fc=1000*Math.pow(r,k), fl=fc/edgeHalf, fh=fc*edgeHalf;
        if(fh<fmin||fl>fm) continue;
        arr.push({fc, fl:Math.max(fl,fmin), fh:Math.min(fh,fm)});
      }
      if(arr.length){
        labelOct.textContent=`${Math.round(arr[0].fc)} Hz ‚Äì ${Math.round(arr[arr.length-1].fc)} Hz`;
        octTitle.textContent=`RTA ‡πÅ‡∏ö‡∏ö 1/${n} Octave (Linear Axis)`;
      }
      return arr;
    }

    function genHeatmapBins(){
      if(!analyser) return null;
      const fm=fmax(), fpb=sampleRate/analyser.fftSize;
      const logFmin=Math.log10(fmin), logFmax=Math.log10(fm);
      const bins=[];
      for(let i=0;i<HEATMAP_FREQ_BINS;i++){
        const logFs=logFmin+(i/HEATMAP_FREQ_BINS)*(logFmax-logFmin);
        const logFe=logFmin+((i+1)/HEATMAP_FREQ_BINS)*(logFmax-logFmin);
        const fStart=Math.pow(10,logFs), fEnd=Math.pow(10,logFe);
        const binStart=Math.max(0,Math.floor(fStart/fpb));
        const binEnd=Math.min(analyser.frequencyBinCount-1,Math.ceil(fEnd/fpb));
        bins.push({binStart,binEnd,fStart,fEnd});
      }
      return bins;
    }

    // ===== Drawing =====
    function drawBackground(ctx){
      const {width:w,height:h}=ctx.canvas;
      ctx.clearRect(0,0,w,h);
      const plotH=h-PAD.T-PAD.B;
      ctx.strokeStyle=GRID_H;
      for(let i=0;i<6;i++){const y=PAD.T+(i/5)*plotH;ctx.beginPath();ctx.moveTo(PAD.L,y);ctx.lineTo(w-PAD.R,y);ctx.stroke();}
      ctx.strokeStyle=GRID_V;
      const ticks=[20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000];
      ticks.forEach(t=>{const x=mapLogX(t,w);ctx.beginPath();ctx.moveTo(x,PAD.T);ctx.lineTo(x,PAD.T+plotH);ctx.stroke();});
      ctx.strokeStyle=FRAME; ctx.strokeRect(PAD.L,PAD.T,w-PAD.L-PAD.R,plotH);
      ctx.fillStyle=LABEL; ctx.font='12px system-ui'; ctx.textBaseline='alphabetic';
      [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{const x=mapLogX(t,w);ctx.fillText(t>=1000?(t/1000)+'k':t,x-8,h-LABEL_Y);});
    }
    function drawPeakLine(ctx,x,h,color,dashed=false){const y0=PAD.T,y1=h-PAD.B;ctx.save();ctx.strokeStyle=color;ctx.lineWidth=1;if(dashed)ctx.setLineDash([5,5]);ctx.beginPath();ctx.moveTo(x,y0);ctx.lineTo(x,y1);ctx.stroke();ctx.restore();}
    function drawGuide(ctx,x,h){ctx.save();ctx.strokeStyle='rgba(96,165,250,.75)';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(x,PAD.T);ctx.lineTo(x,h-PAD.B);ctx.stroke();ctx.restore();}

    function drawFFT(){
      const {width:w,height:h}=ctxFFT.canvas; drawBackground(ctxFFT); if(!freqArray) return;
      const N=freqArray.length, fpb=sampleRate/(2*N);
      let peakBin=0, peakVal=-Infinity; for(let i=0;i<N;i++) if(freqArray[i]>peakVal){peakVal=freqArray[i];peakBin=i;}
      const peakFreqNow=peakBin*fpb; const peakDbNow=dbfs(freqArray[peakBin]||0); peakEl.textContent=Math.round(peakFreqNow)+' Hz';
      if(!peakArray||peakArray.length!==N) peakArray=new Uint8Array(N);
      if(holdEnabled) for(let i=0;i<N;i++) peakArray[i]=Math.max(peakArray[i],freqArray[i]);
      ctxFFT.beginPath(); let started=false;
      for(let i=1;i<N;i++){const f=i*fpb; if(f<20)continue; if(f>20000)break; const x=mapLogX(f,w), y=mapDbToY(dbfs(freqArray[i]),h); if(!started){ctxFFT.moveTo(x,y);started=true;} else ctxFFT.lineTo(x,y);}
      ctxFFT.strokeStyle=FFT_COLOR; ctxFFT.lineWidth=2; ctxFFT.stroke();
      ctxFFT.beginPath(); started=false;
      for(let i=1;i<N;i++){const f=i*fpb; if(f<20)continue; if(f>20000)break; const x=mapLogX(f,w), y=mapDbToY(dbfs(peakArray[i]||0),h); if(!started){ctxFFT.moveTo(x,y);started=true;} else ctxFFT.lineTo(x,y);}
      ctxFFT.save(); ctxFFT.globalAlpha=.35; ctxFFT.strokeStyle=PEAK_COLOR; ctxFFT.lineWidth=1.25; ctxFFT.stroke(); ctxFFT.restore();
      drawPeakLine(ctxFFT,mapLogX(peakFreqNow,w),h,'rgba(96,165,250,.6)');
      let holdBin=0, holdVal=0; for(let i=0;i<N;i++) if(peakArray[i]>holdVal){holdVal=peakArray[i];holdBin=i;}
      if(holdVal>0) drawPeakLine(ctxFFT,mapLogX(holdBin*fpb,w),h,'rgba(250,204,21,.55)',true);
      fftPeakText.textContent=`Peak: ${fmtHz(peakFreqNow)} ‚Ä¢ ${peakDbNow.toFixed(1)} dBFS`;
      if(holdVal>0){fftHoldText.style.display=''; fftHoldText.textContent=`Hold: ${fmtHz(holdBin*fpb)} ‚Ä¢ ${dbfs(holdVal).toFixed(1)} dBFS`;} else fftHoldText.style.display='none';
      if(guideFFT) drawGuide(ctxFFT,guideFFT.xPx,h);
    }

    function drawOctave(){
      const {width:w,height:h}=ctxOct.canvas; drawBackground(ctxOct); if(!freqArray||!bands.length) return;
      const N=freqArray.length, fpb=sampleRate/(2*N);
      const vals=bands.map(b=>{const s=Math.max(0,Math.floor(b.fl/fpb)), e=Math.min(N-1,Math.ceil(b.fh/fpb)); let sum=0,cnt=0; for(let i=s;i<=e;i++){sum+=freqArray[i];cnt++;} let v=cnt?(sum/cnt):0; if(aWeightChk.checked) v*=Math.pow(10,aWeighting(b.fc)/20); return v;});
      if(!peakOct||peakOct.length!==vals.length) peakOct=new Float32Array(vals.length);
      if(holdEnabled) for(let i=0;i<vals.length;i++) peakOct[i]=Math.max(peakOct[i],vals[i]);
      ctxOct.fillStyle=BAR_COLOR;
      for(let i=0;i<vals.length;i++){const b=bands[i]; const xL=mapLogX(b.fl,w), xR=mapLogX(b.fh,w); const barW=Math.max(2,xR-xL-2); const y=mapLinearToYOct(vals[i],h); const hh=(h-PAD.B-y); ctxOct.fillRect(xL+1,y,barW,Math.max(1,hh));}
      ctxOct.beginPath(); for(let i=0;i<vals.length;i++){const cx=mapLogX(bands[i].fc,w); const y=mapLinearToYOct(peakOct[i]||0,h); if(i===0) ctxOct.moveTo(cx,y); else ctxOct.lineTo(cx,y);} ctxOct.save(); ctxOct.globalAlpha=.45; ctxOct.strokeStyle=HOLD_COLOR; ctxOct.lineWidth=1.5; ctxOct.stroke(); ctxOct.restore();
      let idxNow=0,vNow=-1; for(let i=0;i<vals.length;i++) if(vals[i]>vNow){vNow=vals[i];idxNow=i;}
      drawPeakLine(ctxOct,mapLogX(bands[idxNow].fc,w),h,'rgba(96,165,250,.6)');
      let idxHold=0,vHold=0; for(let i=0;i<peakOct.length;i++) if(peakOct[i]>vHold){vHold=peakOct[i];idxHold=i;}
      if(vHold>0) drawPeakLine(ctxOct,mapLogX(bands[idxHold].fc,w),h,'rgba(250,204,21,.55)',true);
      octPeakText.textContent=`Peak: ${fmtHz(bands[idxNow].fc)} ‚Ä¢ ${vNow.toFixed(1)} / ${octRangeMax}`;
      if(vHold>0){octHoldText.style.display=''; octHoldText.textContent=`Hold: ${fmtHz(bands[idxHold].fc)} ‚Ä¢ ${vHold.toFixed(1)} / ${octRangeMax}`;} else octHoldText.style.display='none';
      if(guideOCT) drawGuide(ctxOct,guideOCT.xPx,h);
    }

    function drawOverlayMessage(ctx,w,h){ctx.fillStyle='rgba(255,255,255,.4)';ctx.font='24px system-ui';ctx.textAlign='center';ctx.textBaseline='middle';ctx.fillText('Heatmap OFF',w/2,h/2);}
    function drawHeatmapGuide(ctx,x,h){ctx.save();ctx.strokeStyle='rgba(96,165,250,.75)';ctx.setLineDash([4,4]);ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,h-PAD.B);ctx.stroke();ctx.restore();}

    function drawHeatmap(){
      const {width:w,height:h}=ctxHeatmap.canvas; const plotH=h-PAD.B; if(!freqArray||!heatmapFreqBinMap) return;

      // ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏° running stats ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö relative
      if(heatScaleMode==='rel' && (!relMean || relMean.length!==heatmapFreqBinMap.length)){
        relMean=new Array(heatmapFreqBinMap.length);
        relVar=new Array(heatmapFreqBinMap.length);
      }

      // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏ü‡∏£‡∏°
      const frame=heatmapFreqBinMap.map((bin,i)=>{
        let sum=0,cnt=0; for(let j=bin.binStart;j<=bin.binEnd;j++){sum+=freqArray[j];cnt++;}
        const db=cnt>0?dbfs(sum/cnt):-100;
        if(heatScaleMode==='rel') updateRunningStats(i, db);
        return {db,i,fStart:bin.fStart,fEnd:bin.fEnd};
      });

      heatmapData.unshift(frame); if(heatmapData.length>HM_HISTORY) heatmapData.pop();

      // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏™‡πÄ‡∏Å‡∏•
      let vmin=heatDbMin, vmax=heatDbMax;
      if(heatScaleMode==='auto'){
        const flat=heatmapData.flat().map(d=>d.db);
        vmin=percentile(flat,10);
        vmax=percentile(flat,95);
        if(vmax-vmin<10) vmax=vmin+10;
      }

      // ‡∏ß‡∏≤‡∏î
      const timeScale=plotH/HM_HISTORY; ctxHeatmap.clearRect(0,0,w,h);
      for(let t=0;t<heatmapData.length;t++){
        const y=t*timeScale, row=heatmapData[t];
        for(let k=0;k<row.length;k++){
          const {fStart,fEnd,db,i}=row[k];
          let tnorm;
          if(heatScaleMode==='rel'){
            const z=zScore(i, db); // z > 0 = ‡πÇ‡∏î‡∏î‡πÄ‡∏î‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
            const zMax=4; // cap
            tnorm=Math.min(1, Math.max(0, z/zMax));
          }else{
            tnorm=norm01(db, vmin, vmax, heatGamma);
          }
          ctxHeatmap.fillStyle=mapDbToColorNorm(tnorm);
          const xL=mapLogX(fStart,w), xR=mapLogX(fEnd,w);
          ctxHeatmap.fillRect(xL,y,Math.max(1,xR-xL),timeScale);
        }
      }

      // ‡πÅ‡∏Å‡∏ô‡∏•‡πà‡∏≤‡∏á
      ctxHeatmap.clearRect(0,plotH,w,PAD.B);
      ctxHeatmap.strokeStyle=GRID_V;
      [20,31.5,40,50,63,80,100,125,160,200,250,315,400,500,630,800,1000,2000,4000,8000,16000].forEach(t=>{
        const x=mapLogX(t,w); ctxHeatmap.beginPath(); ctxHeatmap.moveTo(x,0); ctxHeatmap.lineTo(x,plotH); ctxHeatmap.stroke();
      });
      ctxHeatmap.fillStyle=LABEL; ctxHeatmap.font='12px system-ui'; ctxHeatmap.textBaseline='alphabetic';
      [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{const x=mapLogX(t,w); ctxHeatmap.fillText(t>=1000?(t/1000)+'k':t, x-8, h-LABEL_Y);});

      if(guideHeatmap) drawHeatmapGuide(ctxHeatmap,guideHeatmap.xPx,h);
    }

    function updateRMS(){ if(!dataArray) return; let sum=0; for(let i=0;i<dataArray.length;i++){const v=(dataArray[i]-128)/128; sum+=v*v;} const rms=Math.sqrt(sum/dataArray.length); rmsEl.textContent=(20*Math.log10(rms+1e-12)).toFixed(1)+' dBFS'; }
    function calculateDba(){ if(!freqArray||!analyser) return -Infinity; const N=freqArray.length, fpb=sampleRate/analyser.fftSize; let sum=0; for(let i=0;i<N;i++){const f=i*fpb; const aw=Math.pow(10,aWeighting(f)/20); const v=freqArray[i]*aw; sum+=v*v;} const rms=Math.sqrt(sum/N); const dbfsValue=20*Math.log10(rms/255+1e-12); return dbfsValue+calibrationOffset; }
    function drawDbMeterBackground(){const {width:w,height:h}=ctxDbMeter.canvas; ctxDbMeter.clearRect(0,0,w,h);}
    function updateDbMeter(db){const {width:w,height:h}=ctxDbMeter.canvas; const dbMin=0,dbMax=140; const fillW=w*clamp01((db-dbMin)/(dbMax-dbMin)); const g=ctxDbMeter.createLinearGradient(0,0,w,0); g.addColorStop(0,getStyle('--dba-meter-bg-0-50')); g.addColorStop(.357,getStyle('--dba-meter-bg-50-70')); g.addColorStop(.5,getStyle('--dba-meter-bg-70-90')); g.addColorStop(.642,getStyle('--dba-meter-bg-90-140')); drawDbMeterBackground(); ctxDbMeter.fillStyle=g; ctxDbMeter.fillRect(0,0,fillW,h); }
    function resetDbaValues(){maxDba=-Infinity; dbaValues=[]; dbRealtimeValue.textContent='‚Äî'; dbAvgValue.textContent='‚Äî'; dbMaxValue.textContent='‚Äî';}

    // ===== Loop =====
    function loop(){
      if(!running) return;
      analyser.getByteTimeDomainData(dataArray);
      analyser.getByteFrequencyData(freqArray);
      if(avgChk.checked){
        if(!avgBuffer||avgBuffer.length!==freqArray.length) avgBuffer=new Float32Array(freqArray.length);
        const a=.5; for(let i=0;i<freqArray.length;i++){avgBuffer[i]=a*avgBuffer[i]+(1-a)*freqArray[i]; freqArray[i]=avgBuffer[i];}
      }
      drawFFT(); drawOctave(); updateRMS();
      const dbAraw=calculateDba(), dbAdisp=Math.max(0,dbAraw); updateDbMeter(dbAdisp);
      if(dbaValues.length===0){ if(dbAdisp>0){dbaValues.push(dbAdisp); dbRealtimeValue.textContent=`${dbAdisp.toFixed(1)} dB-A`; dbAvgValue.textContent=dbMaxValue.textContent=`${dbAdisp.toFixed(1)} dB-A`; maxDba=dbAdisp;} else {dbRealtimeValue.textContent='‚Äî'; dbAvgValue.textContent='‚Äî'; dbMaxValue.textContent='‚Äî';}}
      else{ dbRealtimeValue.textContent=`${dbAdisp.toFixed(1)} dB-A`; if(dbAdisp>maxDba){maxDba=dbAdisp; dbMaxValue.textContent=`${maxDba.toFixed(1)} dB-A`;} if(dbAdisp>0){dbaValues.push(dbAdisp); if(dbaValues.length>100) dbaValues.shift();} const avg=dbaValues.reduce((a,b)=>a+b,0)/dbaValues.length; dbAvgValue.textContent=`${avg.toFixed(1)} dB-A`; }
      const now=performance.now(); if(heatmapEnabled && (now-lastHeatmapUpdate>=HEATMAP_UPDATE_MS)){drawHeatmap(); lastHeatmapUpdate=now;} else if(!heatmapEnabled){ctxHeatmap.clearRect(0,0,heatmapCanvas.width,heatmapCanvas.height); drawHeatmapBackground(ctxHeatmap); drawOverlayMessage(ctxHeatmap,heatmapCanvas.width,heatmapCanvas.height);}
      rafId=requestAnimationFrame(loop);
    }

    // ===== Start/Stop =====
    async function start(){
      const showErr=(msg)=>{const box=document.getElementById('errBox'); const el=document.getElementById('errMsg'); if(box&&el){box.style.display='block'; el.textContent=msg;}};
      try{
        btnStart.disabled=true; btnStop.disabled=false;
        if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia) throw new Error('‡πÄ‡∏ö‡∏£‡∏≤‡πÄ‡∏ã‡∏≠‡∏£‡πå‡πÑ‡∏°‡πà‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö getUserMedia');
        const aggressive={audio:{echoCancellation:false,noiseSuppression:false,autoGainControl:false}};
        let stream=null; try{stream=await navigator.mediaDevices.getUserMedia(aggressive);}catch{stream=await navigator.mediaDevices.getUserMedia({audio:true});}
        audioCtx=new (window.AudioContext||window.webkitAudioContext)({latencyHint:'interactive'});
        if(audioCtx.state==='suspended') await audioCtx.resume();
        sampleRate=audioCtx.sampleRate; labelRate.textContent=`${Math.round(sampleRate)} Hz`;
        analyser=audioCtx.createAnalyser(); analyser.fftSize=parseInt(fftSel.value,10); analyser.smoothingTimeConstant=parseFloat(smoothing.value);
        micSrc=audioCtx.createMediaStreamSource(stream); micSrc.connect(analyser);
        dataArray=new Uint8Array(analyser.fftSize); freqArray=new Uint8Array(analyser.frequencyBinCount); peakArray=new Uint8Array(analyser.frequencyBinCount);
        bands=genBands(octN); peakOct=new Float32Array(bands.length);
        heatmapFreqBinMap=genHeatmapBins(); heatmapData=[]; lastHeatmapUpdate=0;
        const box=document.getElementById('errBox'); if(box) box.style.display='none';
        running=true; drawDbMeterBackground(); resetDbaValues(); loop();
      }catch(err){console.error(err); showErr(err&&err.message?err.message:String(err)); btnStart.disabled=false; btnStop.disabled=true;}
    }
    function stop(){
      running=false; if(rafId) cancelAnimationFrame(rafId);
      try{micSrc&&micSrc.disconnect();}catch{} try{analyser&&analyser.disconnect();}catch{}
      if(audioCtx) audioCtx.close();
      btnStart.disabled=false; btnStop.disabled=true;
      dbRealtimeValue.textContent='‚Äî'; updateDbMeter(-Infinity);
    }

    // ===== Interactions =====
    function attachPressGuide(canvas,tipEl,which){
      let pressed=false;
      const getX=(e)=>{const r=canvas.getBoundingClientRect(); const xCss=(e.touches?e.touches[0].clientX:e.clientX)-r.left; return Math.max(PAD.L,Math.min(canvas.width-PAD.R,xCss*(canvas.width/r.width)));};
      const update=(xPx)=>{const freq=xToFreq(xPx,canvas.width); const plot=canvas.parentElement.getBoundingClientRect(); tipEl.style.display='block'; tipEl.textContent=fmtHz(freq); const cssX=(xPx/canvas.width)*plot.width; tipEl.style.left=cssX+'px'; tipEl.style.top='8px'; if(which==='fft') guideFFT={xPx,freq}; else if(which==='oct') guideOCT={xPx,freq}; else if(which==='heatmap'){guideHeatmap={xPx,freq}; const w=heatmapCanvas.width,h=heatmapCanvas.height; ctxHeatmap.clearRect(0,0,w,h); if(heatmapEnabled) drawHeatmap(); else {drawHeatmapBackground(ctxHeatmap); drawOverlayMessage(ctxHeatmap,w,h);} drawHeatmapGuide(ctxHeatmap,guideHeatmap.xPx,h);} };
      const clear=()=>{pressed=false; tipEl.style.display='none'; if(which==='fft') guideFFT=null; else if(which==='oct') guideOCT=null; else if(which==='heatmap'){guideHeatmap=null; if(heatmapEnabled) drawHeatmap(); else {const w=heatmapCanvas.width,h=heatmapCanvas.height; ctxHeatmap.clearRect(0,0,w,h); drawHeatmapBackground(ctxHeatmap); drawOverlayMessage(ctxHeatmap,w,h);}}};
      const onDown=(e)=>{pressed=true; e.preventDefault(); update(getX(e));};
      const onMove=(e)=>{if(!pressed) return; e.preventDefault(); update(getX(e));};
      const onUp=()=>clear();
      canvas.addEventListener('mousedown',onDown); canvas.addEventListener('mousemove',onMove); canvas.addEventListener('mouseup',onUp); canvas.addEventListener('mouseleave',onUp);
      canvas.addEventListener('touchstart',onDown,{passive:false}); canvas.addEventListener('touchmove',onMove,{passive:false}); canvas.addEventListener('touchend',onUp);
    }
    function drawHeatmapBackground(ctx){const {width:w,height:h}=ctx.canvas; const plotH=h-PAD.B; ctx.clearRect(0,0,w,h); ctx.strokeStyle=FRAME; ctx.strokeRect(PAD.L,0,w-PAD.L-PAD.R,plotH); ctx.fillStyle=LABEL; ctx.font='12px system-ui'; ctx.textBaseline='alphabetic'; [31.5,63,125,250,500,1000,2000,4000,8000,16000].forEach(t=>{const x=mapLogX(t,w); ctx.fillText(t>=1000?(t/1000)+'k':t,x-8,h-LABEL_Y);});}

    btnStart.onclick=start;
    btnStop.onclick=stop;
    btnHold.onclick=()=>{holdEnabled=!holdEnabled; btnHold.setAttribute('aria-pressed',holdEnabled); btnHold.textContent=`üìå Hold Peak: ${holdEnabled?'ON':'OFF'}`;};
    btnClear.onclick=()=>{if(peakArray) peakArray.fill(0); if(peakOct) peakOct.fill(0); if(running){drawFFT(); drawOctave();}};
    btnToggleHeatmap.onclick=()=>{heatmapEnabled=!heatmapEnabled; btnToggleHeatmap.setAttribute('aria-pressed',heatmapEnabled); btnToggleHeatmap.textContent=`üî• Heatmap: ${heatmapEnabled?'ON':'OFF'}`; const w=heatmapCanvas.width,h=heatmapCanvas.height; if(running){ if(heatmapEnabled){heatmapData=[]; lastHeatmapUpdate=0;} drawHeatmap(); } else {ctxHeatmap.clearRect(0,0,w,h); drawHeatmapBackground(ctxHeatmap); if(!heatmapEnabled) drawOverlayMessage(ctxHeatmap,w,h);} };

    fftSel.onchange=()=>{ if(analyser){stop(); start();} };
    smoothing.oninput=()=>{ if(analyser) analyser.smoothingTimeConstant=parseFloat(smoothing.value); };

    // Octave res
    octResSel.onchange=()=>{octN=parseInt(octResSel.value,10); bands=genBands(octN); peakOct=new Float32Array(bands.length); drawOctave();};

    // Dynamic Range controls
    function applyOctRange(newMax){
      octRangeMax=Math.max(1,parseInt(newMax,10)||255);
      octRangeSlider.value=String(octRangeMax);
      octRangePreset.value=String([127,255,511].includes(octRangeMax)?octRangeMax:255);
      octRangeText.textContent=`0‚Äì${octRangeMax}`;
      if(peakOct) peakOct.fill(0);
      drawOctave();
    }
    octRangePreset.onchange=()=>applyOctRange(octRangePreset.value);
    octRangeSlider.oninput=()=>applyOctRange(octRangeSlider.value);

    // Heatmap scaling controls
    function syncHeatAbsVisibility(){
      const show = heatScaleMode==='abs';
      heatAbsMinWrap.style.display = show ? '' : 'none';
      heatAbsMaxWrap.style.display = show ? '' : 'none';
    }
    heatScaleModeSel.onchange=()=>{heatScaleMode=heatScaleModeSel.value; syncHeatAbsVisibility();};
    heatMinInp.onchange=()=>{heatDbMin=parseFloat(heatMinInp.value)||-70;};
    heatMaxInp.onchange=()=>{heatDbMax=parseFloat(heatMaxInp.value)||-20; if(heatDbMax<=heatDbMin) heatDbMax=heatDbMin+1; heatMaxInp.value=heatDbMax;};
    heatGammaInp.oninput=()=>{heatGamma=parseFloat(heatGammaInp.value)||1.0;};

    calibrationInput.onchange=()=>{calibrationOffset=parseFloat(calibrationInput.value)||0;};
    btnResetDba.onclick=resetDbaValues;

    attachPressGuide(fftCanvas,fftTip,'fft');
    attachPressGuide(octCanvas,octTip,'oct');
    attachPressGuide(heatmapCanvas,heatmapTip,'heatmap');

    // initial paints
    drawBackground(ctxFFT);
    drawBackground(ctxOct);
    drawHeatmapBackground(ctxHeatmap);
    drawOverlayMessage(ctxHeatmap,heatmapCanvas.width,heatmapCanvas.height);
    (function initDb(){const {width:w,height:h}=ctxDbMeter.canvas; ctxDbMeter.clearRect(0,0,w,h);})();

    // sync UI ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å
    applyOctRange(octRangePreset.value);
    syncHeatAbsVisibility();

  })();
  </script>
</body>
</html>
